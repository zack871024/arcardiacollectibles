<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcadia One Piece TCG Search</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 90%;
            margin: 20px;
            overflow-y: auto;
            max-height: 90vh;
        }

        select, input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .results {
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }

        .card {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .card img {
            width: 60px;
            height: 80px;
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .add-to-cart {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .cart {
            margin-top: 20px;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            text-align: left;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .cart-item img {
            width: 40px;
            height: 50px;
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid #ddd;
        }

        .cart-item-controls button {
            margin: 0 3px;
        }

        .remove-item {
            background-color: #FF4D4D;
            color: white;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .clear-cart {
            background-color: #FF9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>Arcadia One Piece TCG Search Engine</h2>

    <!-- Primary Set Type -->
    <select id="setTypeSelect">
        <option value="">All Types</option>
        <option value="OP">OP</option>
        <option value="EB">EB</option>
        <option value="ST">ST</option>
    </select>

    <!-- Subcategory -->
    <select id="setNumberSelect" disabled>
        <option value="">All Sets</option>
    </select>

    <!-- Search -->
    <div style="display:flex; gap:10px;">
        <input type="text" id="searchBar" placeholder="Search by Name or OPXX-XXX..." style="flex:1;">
        <button id="clearSearch"
            style="padding:10px; border:none; background:#FF4D4D; color:white; border-radius:5px; cursor:pointer;">
            Clear
        </button>
    </div>

    <!-- Results -->
    <div class="results" id="resultsContainer"></div>

    <!-- Cart -->
    <div class="cart">
        <h3>Your Cart</h3>
        <div id="cartContainer"></div>
        <p id="cartTotal"></p>
        <button class="clear-cart" onclick="clearCart()">Clear Cart</button>
    </div>
</div>

<script>
let cards = [];
let cart = [];
let setsByType = {};
let latestSet = "";

async function loadCards() {
    const response = await fetch('search_database.csv?t=' + Date.now());
    const csvText = await response.text();
    cards = parseCSV(csvText);
    populateCategories(cards);
}

function parseCSV(csvText) {
    const rows = csvText.trim().split('\n');
    const headers = rows[0].split(',').map(h => h.trim());

    return rows.slice(1).map(row => {
        const values = row.split(',').map(v => v.trim());
        let entry = {};
        headers.forEach((h, i) => entry[h] = values[i] || '');
        return entry;
    });
}

function populateCategories(cards) {
    setsByType = {};

    cards.forEach(card => {
        const match = card.extNumber.match(/^([A-Z]+)(\d{2})/i);
        if (!match) return;

        const type = match[1].toUpperCase();
        const set = type + match[2];

        if (!setsByType[type]) setsByType[type] = new Set();
        setsByType[type].add(set);
    });

    for (const type in setsByType) {
        setsByType[type] = Array.from(setsByType[type]).sort(customSetSort);
    }

    if (setsByType.OP?.length) {
        latestSet = setsByType.OP[setsByType.OP.length - 1];
        document.getElementById("setTypeSelect").value = "OP";
        populateSubcategories("OP");
        document.getElementById("setNumberSelect").value = latestSet;
        displayResults(cards.filter(c =>
            c.extNumber.toUpperCase().startsWith(latestSet)
        ));
    }
}

function populateSubcategories(type) {
    const sub = document.getElementById("setNumberSelect");
    sub.innerHTML = '<option value="">All Sets</option>';

    if (!type || !setsByType[type]) {
        sub.disabled = true;
        return;
    }

    setsByType[type].forEach(set => {
        const opt = document.createElement("option");
        opt.value = set;
        opt.textContent = set;
        sub.appendChild(opt);
    });

    sub.disabled = false;
}

function customSetSort(a, b) {
    return a.localeCompare(b, undefined, { numeric: true });
}

function searchCards(query) {
    query = query.toLowerCase();
    const type = document.getElementById("setTypeSelect").value;
    const set = document.getElementById("setNumberSelect").value;

    const results = cards.filter(card => {
        const matchQuery = !query ||
            card.name.toLowerCase().includes(query) ||
            card.extNumber.toLowerCase().includes(query);

        const matchType = type
            ? card.extNumber.toUpperCase().startsWith(type)
            : true;

        const matchSet = set
            ? card.extNumber.toUpperCase().startsWith(set)
            : true;

        return matchQuery && matchType && matchSet;
    });

    displayResults(results);
}

function displayResults(results) {
    const container = document.getElementById("resultsContainer");
    container.innerHTML = '';

    if (!results.length) {
        container.innerHTML = "<p>No cards found.</p>";
        return;
    }

    results.forEach(card => {
        const usd = parseFloat(card.marketPrice);
        const cad = (usd * 1.5).toFixed(2);

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <img src="${card.imageUrl}">
            <div>
                <strong><a href="${card.url}" target="_blank">${card.name}</a></strong>
                (${card.extNumber})
                <p>$${usd.toFixed(2)} USD (CAD $${cad})</p>
                <button class="add-to-cart"
                    onclick="addToCart('${card.extNumber}','${card.name}',${usd},'${card.imageUrl}','${card.url}')">
                    Add to Cart
                </button>
            </div>
        `;
        container.appendChild(div);
    });
}

function addToCart(extNumber, name, price, imageUrl, url) {
    const item = cart.find(c =>
        c.extNumber === extNumber && c.price === price && c.url === url
    );

    item ? item.quantity++ : cart.push({ extNumber, name, price, imageUrl, url, quantity: 1 });
    updateCart();
}

function updateCart() {
    const c = document.getElementById("cartContainer");
    const t = document.getElementById("cartTotal");
    c.innerHTML = '';
    let total = 0;

    cart.forEach(card => {
        total += card.price * card.quantity;
        c.innerHTML += `
            <div class="cart-item">
                <img src="${card.imageUrl}">
                <div>${card.name} (${card.extNumber})</div>
                <div>
                    <button onclick="changeQuantity('${card.extNumber}',${card.price},'${card.url}',-1)">-</button>
                    ${card.quantity}
                    <button onclick="changeQuantity('${card.extNumber}',${card.price},'${card.url}',1)">+</button>
                    <button class="remove-item"
                        onclick="removeItem('${card.extNumber}',${card.price},'${card.url}')">Remove</button>
                </div>
            </div>
        `;
    });

    t.innerText = `Total: $${total.toFixed(2)} USD (CAD $${(total*1.5).toFixed(2)})`;
}

function changeQuantity(ext, price, url, delta) {
    const card = cart.find(c => c.extNumber === ext && c.price === price && c.url === url);
    if (!card) return;
    card.quantity += delta;
    if (card.quantity <= 0) removeItem(ext, price, url);
    updateCart();
}

function removeItem(ext, price, url) {
    cart = cart.filter(c => !(c.extNumber === ext && c.price === price && c.url === url));
    updateCart();
}

function clearCart() {
    cart = [];
    updateCart();
}

document.getElementById("searchBar").addEventListener("input", e => searchCards(e.target.value));
document.getElementById("setTypeSelect").addEventListener("change", e => {
    populateSubcategories(e.target.value);
    document.getElementById("setNumberSelect").value = "";
    searchCards(document.getElementById("searchBar").value);
});
document.getElementById("setNumberSelect").addEventListener("change", () =>
    searchCards(document.getElementById("searchBar").value)
);
document.getElementById("clearSearch").addEventListener("click", () => {
    document.getElementById("searchBar").value = "";
    populateCategories(cards);
});

loadCards();
</script>

</body>
</html>
